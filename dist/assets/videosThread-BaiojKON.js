/* empty css               *//* empty css              *//* empty css             */(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const n of s.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function t(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(o){if(o.ep)return;o.ep=!0;const s=t(o);fetch(o.href,s)}})();class k{constructor(e={}){this.currentVideoElement=null,this.nextVideoElement=null,this.thirdVideoElement=null,this.staticNoiseElement=null,this.staticElement=null,this.noiseCanvas=null,this.noiseCtx=null,this.videos=[],this.playedVideos=new Set,this.currentIndex=-1,this.nextIndex=-1,this.thirdIndex=-1,this.isVideoPreloaded=!1,this.isThirdVideoPreloaded=!1,this.volume=0,this.isDragging=!1,this.noiseAnimationId=null,this.slapCounter=0,this.audioContext=null,this.whiteNoiseBuffer=null,this.crackleNoiseBuffer=null,this.staticNoiseSource=null,this.crackleSource=null,this.gainNode=null,this.isBufferingScheduledVideo=!1,this.isScheduledVideoPlaying=!1,this.scheduledVideoElement=null,this.PROGRAM_SEED=e.programSeed||247420,this.schedule=[],this.currentProgramIndex=0,this.scheduledPlayTimeout=null,this.weeklySchedule=null,this.currentWeek=null,this.scheduleStart=null,this.adBreakSeed=e.adBreakSeed||247420,this.currentAdBreak=null,this.adQueue=[],this.adPreloadElements={ad1:null,ad2:null,ad3:null},this.isAdPreloaded={ad1:!1,ad2:!1,ad3:!1},this.currentAdIndex=0,this.adsPlayedInHour=new Set,this.basePath=e.basePath||"",this.schedulePath=e.schedulePath||"/static/video-schedule.json",this.weeklySchedulePath=e.weeklySchedulePath||"/public/schedule_weeks/",this.isDevelopment=e.isDevelopment||this.detectDevelopmentMode(),e.autoInit!==!1&&(this.checkIframeMode(),this.initAudioNoise())}detectDevelopmentMode(){return window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"||window.location.hostname.includes(".local")||window.location.protocol==="file:"}async init(){try{this.initializeElements(),await this.loadVideos(),await this.loadWeeklySchedule(),this.setupEventListeners(),this.setupVolumeControl(),this.setupAudioInteraction(),this.startNoiseAnimation(),this.generateProgramSchedule(),await this.startHybridBroadcast(),console.log("üì∫ Schwelevision initialized successfully")}catch(e){console.error("‚ùå Error initializing Schwelevision:",e),this.showError("NO SIGNAL")}}initializeElements(){if(this.currentVideoElement=document.getElementById("currentVideo"),this.nextVideoElement=document.getElementById("nextVideo"),this.thirdVideoElement=document.getElementById("thirdVideo"),this.staticNoiseElement=document.getElementById("staticNoise"),this.staticElement=document.getElementById("static"),this.noiseCanvas=document.getElementById("noiseCanvas"),this.noiseCanvas&&(this.noiseCtx=this.noiseCanvas.getContext("2d")),!this.currentVideoElement||!this.staticElement)throw new Error("Required DOM elements not found")}checkIframeMode(){if(window.self!==window.top){console.log("üì∫ Schwelevision loaded in iframe - enabling embed mode"),document.body.classList.add("iframe-mode");try{window.parent.postMessage({type:"schwelevision-ready",aspectRatio:"4:3",isFullscreen:!0},"*")}catch{console.log("üì∫ Cross-origin iframe detected")}}}async loadVideos(){try{const e=await fetch(this.schedulePath);if(!e.ok)throw new Error("Failed to fetch schedule");const t=await e.json();this.videos=t.videos,this.loopSchedule=t.loop,this.loopDuration=t.loopDurationMs,this.epochStart=t.epochStart,console.log(`üì∫ Loaded ${this.videos.length} videos, loop duration: ${(this.loopDuration/6e4).toFixed(1)}min`)}catch(e){console.error("‚ùå Error loading schedule:",e),this.showError("NO SIGNAL")}}async loadWeeklySchedule(){try{const e=this.getCurrentWeek();await this.loadWeekData(e),console.log(`üìÖ Loaded weekly schedule for week ${e}`)}catch(e){console.log("‚ö†Ô∏è Could not load weekly schedule, using default programming:",e.message),this.weeklySchedule=null}}getCurrentWeek(){const e=new Date,o=Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds(),e.getUTCMilliseconds())-new Date("2025-10-11T00:00:00Z").getTime();return o<0?1:Math.floor(o/(7*24*60*60*1e3))+1}async loadWeekData(e){try{const t=await fetch(`${this.weeklySchedulePath}week_${e}.json`);if(!t.ok)throw new Error(`Week ${e} not found`);const i=await t.json();this.weeklySchedule=i,this.scheduleStart=new Date(i.m.start),this.currentWeek=e}catch(t){throw new Error(`Failed to load week ${e}: ${t.message}`)}}async checkWeekTransition(){const e=this.getCurrentWeek();e!==this.currentWeek&&(console.log(`üìÖ Week transition: ${this.currentWeek} ‚Üí ${e}`),await this.loadWeekData(e))}async getCurrentScheduledVideo(){if(!this.weeklySchedule)return null;await this.checkWeekTransition();const e=new Date,i=Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds(),e.getUTCMilliseconds())-this.scheduleStart.getTime();if(i<0)return null;const o=Math.floor(i/(7*24*60*60*1e3))+1,s=i%(7*24*60*60*1e3),n=Math.floor(s/(24*60*60*1e3)),l=Math.floor(s%(24*60*60*1e3)/(60*60*1e3)),E=Math.floor(s%(60*60*1e3)/(60*1e3)),S=Math.floor(s%(60*1e3)/1e3),v=(6+n)%7,V=v===0?6:v-1,u=this.weeklySchedule.m.days[V],g=this.weeklySchedule.s.filter(a=>a.d===u&&this.parseTime(a.t)===l);if(g.length===0)return console.log(`üìÖ No scheduled programming for ${u} ${l}:00, falling back to Schwepevision`),null;const r=[];let m=0;for(const a of g){const c=this.weeklySchedule.v[a.v];if(!c)continue;const h=c.du||a.du||0;m+=h,r.push({...c,duration:h,day:u,week:o,time:a.t,filename:a.v,slotIndex:r.length})}if(r.length===0)return console.log(`üìÖ No valid video clips for ${u} ${l}:00, falling back to Schwepevision`),null;const P=this.parseTime(g[0].t),f=((l-P)*60+E)*60+S;let y=f,d=null;for(const a of r){if(y<a.duration){d={...a,position:y,totalPosition:f,clipsInSlot:r,slotDuration:m};break}y-=a.duration}if(!d){const a=f%m;let c=a;for(const h of r){if(c<h.duration){d={...h,position:c,totalPosition:a,clipsInSlot:r,slotDuration:m};break}c-=h.duration}}return console.log(`üìÖ Found ${r.length} scheduled clips for ${u} ${l}:00, total duration: ${m}s`),console.log(`üìÖ Playing clip ${d.slotIndex+1}/${r.length}: ${d.show||d.filename} at position ${d.position}s`),d}parseTime(e){const[t,i]=e.split(":").map(Number);return t}showError(e){const t=document.getElementById("loadingText");t&&(t.textContent=e)}setupEventListeners(){this.currentVideoElement&&(this.currentVideoElement.addEventListener("ended",()=>{this.isScheduledVideoPlaying||this.onVideoEnd()}),this.currentVideoElement.addEventListener("error",e=>{console.error("Video error:",e),this.playRandomVideo(!0)}),document.addEventListener("keydown",e=>{e.key==="f"||e.key==="F"?this.toggleFullscreen():e.key==="Escape"&&document.fullscreenElement&&document.exitFullscreen()}),document.addEventListener("visibilitychange",()=>{document.hidden?this.stopNoiseAnimation():this.startNoiseAnimation()}))}toggleFullscreen(){const e=document.querySelector(".tv-container");document.fullscreenElement?document.exitFullscreen():e.requestFullscreen().catch(t=>{console.log(`Error attempting to enable fullscreen: ${t.message}`)})}async playRandomVideo(e=!1){try{e&&this.showStaticBetweenVideos();const t=this.getRandomIndex(),i=this.videos[t];if(!i)throw new Error("No valid video found");await this.playVideo(i,t)}catch(t){console.error("Error playing random video:",t)}}getRandomIndex(){const e=this.videos.filter((t,i)=>!this.playedVideos.has(i));if(e.length===0)return this.playedVideos.clear(),Math.floor(Math.random()*this.videos.length);if(Math.random()<.9&&e.length>0){const t=e[Math.floor(Math.random()*e.length)];return this.videos.indexOf(t)}return Math.floor(Math.random()*this.videos.length)}async playVideo(e,t){if(this.currentVideoElement)try{this.currentIndex=t,this.playedVideos.add(t),this.isDevelopment&&e.url&&e.url.startsWith("https://archive.org/")?this.currentVideoElement.src=e.url:this.currentVideoElement.src=`${this.basePath}${e.filename}`,this.currentVideoElement.volume=this.volume,await new Promise((i,o)=>{const s=()=>{this.currentVideoElement.readyState>=2?i():this.currentVideoElement.error?o(new Error("Video loading error")):setTimeout(s,100)};s()}),await this.currentVideoElement.play(),console.log(`üì∫ Playing: ${e.show||e.filename}`)}catch(i){throw console.error("Error playing video:",i),i}}showStaticBetweenVideos(){this.staticElement&&(this.staticElement.classList.add("active","temporal-refresh"),this.playStaticNoise(),setTimeout(()=>{this.staticElement.classList.remove("active","temporal-refresh"),this.stopStaticNoise()},500))}initAudioNoise(){try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.gainNode=this.audioContext.createGain(),this.gainNode.connect(this.audioContext.destination),this.gainNode.gain.value=0}catch(e){console.log("Audio context not available:",e)}}playStaticNoise(){if(!(!this.audioContext||!this.gainNode))try{this.audioContext.state==="suspended"&&this.audioContext.resume(),this.whiteNoiseBuffer||this.createStaticNoise(),this.staticNoiseSource=this.audioContext.createBufferSource(),this.staticNoiseSource.buffer=this.whiteNoiseBuffer,this.staticNoiseSource.loop=!0,this.staticNoiseSource.connect(this.gainNode),this.volume===0?this.gainNode.gain.value=.1:this.gainNode.gain.value=this.volume*.3,this.staticNoiseSource.start(0)}catch(e){console.error("Error playing static noise:",e)}}stopStaticNoise(){if(this.staticNoiseSource)try{this.staticNoiseSource.stop(),this.staticNoiseSource=null}catch{}this.gainNode&&(this.gainNode.gain.value=this.volume)}createStaticNoise(){if(!this.audioContext)return;const e=this.audioContext.sampleRate*2;this.whiteNoiseBuffer=this.audioContext.createBuffer(1,e,this.audioContext.sampleRate);const t=this.whiteNoiseBuffer.getChannelData(0);for(let i=0;i<e;i++)t[i]=Math.random()*2-1}setupVolumeControl(){}setupAudioInteraction(){const e=()=>{this.audioContext&&this.audioContext.state==="suspended"&&this.audioContext.resume(),document.removeEventListener("click",e),document.removeEventListener("touchstart",e)};document.addEventListener("click",e),document.addEventListener("touchstart",e)}startNoiseAnimation(){if(this.noiseAnimationId||!this.noiseCanvas)return;let e=0;const t=100,i=o=>{o-e>t&&(this.generateRandomNoise(),e=o),this.noiseAnimationId=requestAnimationFrame(i)};this.noiseAnimationId=requestAnimationFrame(i)}stopNoiseAnimation(){this.noiseAnimationId&&(cancelAnimationFrame(this.noiseAnimationId),this.noiseAnimationId=null)}generateRandomNoise(){if(!this.noiseCanvas||!this.noiseCtx)return;const e=this.noiseCanvas.width,t=this.noiseCanvas.height,i=this.noiseCtx.createImageData(e,t),o=i.data;for(let s=0;s<o.length;s+=4)if(Math.random()>.3){const n=Math.floor(Math.random()*256);o[s]=n,o[s+1]=n,o[s+2]=n,o[s+3]=255}else o[s]=0,o[s+1]=0,o[s+2]=0,o[s+3]=255;this.noiseCtx.putImageData(i,0,0)}generateProgramSchedule(){}async startHybridBroadcast(){try{const e=await this.getCurrentScheduledVideo();e?(console.log("üìÖ Starting scheduled programming"),await this.startScheduledVideo(e)):(console.log("üì∫ No scheduled content, starting random programming"),await this.playRandomVideo())}catch(e){console.error("Error starting hybrid broadcast:",e),await this.playRandomVideo()}}async startScheduledVideo(e){console.log("üìÖ Starting scheduled video:",e.show||e.filename)}onVideoEnd(){this.isScheduledVideoPlaying||this.playRandomVideo(!0)}destroy(){this.stopNoiseAnimation(),this.stopStaticNoise(),this.currentVideoElement&&(this.currentVideoElement.pause(),this.currentVideoElement.src=""),this.scheduledVideoElement&&(this.scheduledVideoElement.pause(),this.scheduledVideoElement.src=""),this.scheduledPlayTimeout&&clearTimeout(this.scheduledPlayTimeout),this.audioContext&&this.audioContext.state!=="closed"&&this.audioContext.close()}}class p{constructor(){this.videos=[],this.currentVideoIndex=0,this.volume=50,this.isPlaying=!1,this.isBuffering=!1,this.schwelevision=null,this.currentScheduledVideo=null,this.adBreaks=[],this.isAdPlaying=!1,this.loopSchedule=[],this.loopDuration=24*60*60*1e3,this.epochStart=Date.now(),this.currentProgramIndex=0,this.videoElement=null,this.nowPlaying=null,this.loadingText=null,this.initializeSchwelevision()}async initializeSchwelevision(){this.schwelevision=new k({videoElement:"tvVideo",nowPlayingElement:"nowPlaying",loadingElement:"loadingText",schedulePath:"/public/schedule_weeks/",fallbackToSaved:!0,enableAudio:!0});try{await this.schwelevision.initialize(),console.log("‚úÖ Schwelevision initialized successfully")}catch(e){console.error("‚ùå Failed to initialize Schwelevision:",e)}}async initialize(){if(console.log("üöÄ Initializing Enhanced Video Player with 420kit Schwelevision..."),this.videoElement=document.getElementById("tvVideo"),this.nowPlaying=document.getElementById("nowPlaying"),this.loadingText=document.getElementById("loadingText"),!this.videoElement){console.error("‚ùå Video element not found");return}console.log("‚úÖ Enhanced Video Player initialized with 420kit Schwelevision")}setupVideoPlayer(){this.videoElement.addEventListener("loadedmetadata",()=>{console.log("üì∫ Video metadata loaded"),this.isBuffering=!1,this.loadingText&&(this.loadingText.style.display="none")}),this.videoElement.addEventListener("canplay",()=>{console.log("üì∫ Video can play")}),this.videoElement.addEventListener("error",e=>{console.error("‚ùå Video error:",e),this.handleVideoError(e)}),this.videoElement.addEventListener("ended",()=>{console.log("üì∫ Video ended"),this.playNextVideo()}),this.videoElement.addEventListener("timeupdate",()=>{this.checkForAdBreaks()})}async loadVideos(){try{const e=await fetch("/saved_videos.json");if(!e.ok)throw new Error("Failed to fetch videos");const t=await e.json();this.videos=Object.keys(t).map(i=>({filename:i,...t[i]})),console.log(`üìº Loaded ${this.videos.length} videos`),this.scheduler&&(this.scheduler.savedVideos=t)}catch(e){console.error("‚ùå Error loading videos:",e),this.videos=[]}}createLoopSchedule(){if(this.videos.length===0)return;this.loopSchedule=[];let e=0;for(;e<this.loopDuration;)for(const t of this.videos){if(e>=this.loopDuration)break;const i=(t.duration||30)*1e3;this.loopSchedule.push({filename:t.filename,duration:i,offsetMs:e,videoIndex:this.videos.findIndex(o=>o.filename===t.filename)}),e+=i+2e3}console.log(`üì∫ Created loop schedule with ${this.loopSchedule.length} slots`)}async startHybridBroadcast(){console.log("üì° Starting hybrid broadcast...");try{const e=await this.scheduler?.getNextVideo();e&&e.source==="scheduled"?(console.log("üìÖ Playing scheduled content"),await this.playScheduledVideo(e)):(console.log("üì∫ No scheduled content, playing regular programming"),await this.playNextVideo())}catch(e){console.error("‚ùå Error starting broadcast:",e),await this.playNextVideo()}}async playScheduledVideo(e){this.currentScheduledVideo=e,this.adBreaks=e.adBreaks||[];const t=e.u||`/saved_videos/${e.filename}`;console.log(`üìÖ Playing scheduled video with priority URL: ${t}`),console.log(`üìÖ Video source: ${e.u?"External archive.org":"Local fallback"}`);try{const i=document.createElement("video");if(i.src=t,i.volume=0,i.muted=!0,await new Promise((o,s)=>{const n=setTimeout(()=>{s(new Error("Video loading timeout"))},1e4);i.addEventListener("loadedmetadata",()=>{clearTimeout(n),o()},{once:!0}),i.addEventListener("error",l=>{clearTimeout(n),s(l)},{once:!0}),i.load()}),i.duration&&!isNaN(i.duration))this.videoElement.src=t,this.videoElement.currentTime=e.position||0,this.videoElement.volume=this.volume/100,this.videoElement.muted=this.volume===0,await this.videoElement.play(),this.isPlaying=!0,this.updateNowPlaying(e,"scheduled"),console.log(`üìÖ Playing scheduled video: ${e.show||e.filename}`),console.log(`üìÖ Source: ${t}`);else throw new Error("Video has no duration or invalid")}catch(i){console.error("‚ùå Error playing scheduled video:",i),console.log(`üìÖ Failed to load: ${t}`),console.log("üìÖ Falling back to saved videos..."),await this.playNextVideo()}}async playNextVideo(){this.currentScheduledVideo=null,this.adBreaks=[],this.isAdPlaying=!1;const e=await this.scheduler?.getNextVideo();if(e&&e.source!=="saved_videos")e.source==="scheduled"?await this.playScheduledVideo(e):await this.playVideo(e);else{const o=(Date.now()-this.epochStart)%this.loopDuration,s=this.loopSchedule.find(n=>o>=n.offsetMs&&o<n.offsetMs+n.duration);if(s){this.currentProgramIndex=this.loopSchedule.indexOf(s);const n=this.videos[s.videoIndex];await this.playVideo(n)}else{this.currentProgramIndex=(this.currentProgramIndex+1)%this.loopSchedule.length;const n=this.loopSchedule[this.currentProgramIndex],l=this.videos[n.videoIndex];await this.playVideo(l)}}}async playVideo(e){if(!e||!e.filename){console.error("‚ùå Invalid video data");return}try{let t;e.source==="static"?t="/static.mp4":t=`/saved_videos/${e.filename}`,this.videoElement.src=t,this.videoElement.volume=this.volume/100,this.videoElement.muted=this.volume===0,await this.videoElement.play(),this.isPlaying=!0,this.updateNowPlaying(e,e.source||"regular"),console.log(`üì∫ Playing video: ${e.title||e.filename} from ${t}`)}catch(t){console.error("‚ùå Error playing video:",t),this.handleVideoError(t)}}checkForAdBreaks(){if(!this.adBreaks||this.adBreaks.length===0||this.isAdPlaying)return;const e=this.videoElement.currentTime,t=this.adBreaks.find(i=>Math.abs(i.position-e)<1&&!i.played);t&&this.playAdBreak(t)}async playAdBreak(e){console.log("üì∫ Playing ad break"),e.played=!0,this.isAdPlaying=!0;const t=this.videoElement.currentTime,i=this.videoElement.volume;try{await this.playVideo(e.video),this.updateNowPlaying(e.video,"ad"),setTimeout(async()=>{this.isAdPlaying=!1,this.currentScheduledVideo?(this.videoElement.currentTime=t,this.videoElement.volume=i,await this.videoElement.play(),this.updateNowPlaying(this.currentScheduledVideo,"scheduled")):await this.playNextVideo()},(e.video.duration||30)*1e3)}catch(o){console.error("‚ùå Error playing ad:",o),this.isAdPlaying=!1,this.videoElement.currentTime=t,this.videoElement.volume=i,await this.videoElement.play()}}updateNowPlaying(e,t){if(!this.nowPlaying)return;let i="üì∫",o="";switch(t){case"scheduled":i="üìÖ",o="SCHEDULED";break;case"scheduled-local":i="üìÖ",o="SCHEDULED (LOCAL)";break;case"ad":i="üì¢",o="ADVERTISEMENT";break;case"saved_videos":i="üìº",o="SAVED CLIP";break;case"static":i="üì∫",o="STATIC/NOISE";break;default:i="üì∫",o="REGULAR"}const s=e.show||e.title||e.filename||"Unknown";this.nowPlaying.innerHTML=`${i} NOW PLAYING: ${s} [${o}]`}handleVideoError(e){console.error("‚ùå Video playback error:",e),setTimeout(()=>{this.playNextVideo()},2e3)}getSchedulerStatus(){return this.schwelevision?.getStatus()||{hasWeeklySchedule:!1,hasSavedVideos:!1,hasStaticSchedule:!1,isScheduledVideoPlaying:!!this.currentScheduledVideo,isBufferingScheduledVideo:!1,schwelevisionActive:!!this.schwelevision}}async checkForScheduledContent(){if(!this.schwelevision)return;const e=this.schwelevision.getStatus();console.log("üìÖ Schwelevision status:",e)}}window.EnhancedVideoPlayer=p;document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{window.videoPlayer=new p,window.videoPlayer.initialize()}):(window.videoPlayer=new p,window.videoPlayer.initialize());
