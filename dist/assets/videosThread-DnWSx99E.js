/* empty css               *//* empty css              *//* empty css             */(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const n of s.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function t(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(o){if(o.ep)return;o.ep=!0;const s=t(o);fetch(o.href,s)}})();class S{constructor(e={}){this.options={enableScheduledOverride:!0,enableClipAds:!0,maxAdsPerHour:4,minAdDuration:30,maxAdDuration:120,scheduleWeeksPath:"/public/schedule_weeks",savedVideosPath:"/saved_videos.json",timezone:"UTC",scheduleStartDay:6,fallbackToSavedVideos:!0,...e},this.weeklySchedule=null,this.scheduleStart=null,this.savedVideos=null,this.currentSchedule=[],this.isScheduledVideoPlaying=!1,this.isBufferingScheduledVideo=!1,this.scheduledVideoElement=null,this.adBreaks=[],this.currentAdBreak=null,this.eventListeners=new Map}async initialize(){console.log("📅 Initializing 247420 Video Scheduler...");try{return await this.loadSavedVideos(),await this.loadWeeklySchedule(),console.log("✅ Video Scheduler initialized successfully"),!0}catch(e){return console.error("❌ Failed to initialize scheduler:",e),!1}}async loadSavedVideos(){try{const e=await fetch(this.options.savedVideosPath);if(!e.ok)throw new Error("Failed to fetch saved videos");this.savedVideos=await e.json();const t=Object.keys(this.savedVideos).length;console.log(`📼 Loaded ${t} saved videos`)}catch(e){console.error("❌ Error loading saved videos:",e),this.savedVideos={}}}async loadWeeklySchedule(){if(!this.options.enableScheduledOverride){console.log("⚠️ Scheduled override disabled");return}try{const e=new Date,t=this.getWeekNumber(e),i=e.getFullYear();let o=`${this.options.scheduleWeeksPath}/week_${t}.json`;console.log(`📅 Attempting to load schedule: ${o}`);const s=await fetch(o);if(!s.ok)throw new Error(`Week ${t} not found`);const n=await s.json();this.weeklySchedule=n,this.scheduleStart=new Date(n.m.start),console.log(`📅 Loaded weekly schedule for week ${t}`),console.log(`📅 Schedule period: ${this.scheduleStart.toISOString()}`),console.log(`📅 Total scheduled videos: ${Object.keys(this.weeklySchedule.v).length}`)}catch(e){console.log("⚠️ Could not load weekly schedule:",e.message),this.weeklySchedule=null,this.scheduleStart=null}}async getCurrentScheduledVideo(){if(!this.weeklySchedule||!this.scheduleStart)return null;try{const e=new Date,t=new Date(e.toISOString()),i=t.getTime()-this.scheduleStart.getTime(),s=Math.floor(i/(24*60*60*1e3))%7,n=(this.options.scheduleStartDay+s)%7,l=t.getUTCHours(),r=this.weeklySchedule.m.days[n],c=this.weeklySchedule.s.filter(u=>u.d===n&&u.h===l);if(c.length===0)return console.log(`📅 No scheduled programming for ${r} ${l}:00`),null;const h=[];for(const u of c){const m=this.weeklySchedule.v[u.v];m&&h.push({...m,slotIndex:h.length,slotDuration:3600,position:u.p||0,day:r,time:l,clipsInSlot:null})}if(h.length===0)return null;const g=t.getUTCMinutes()*60+t.getUTCSeconds();let d=null,f=0;for(const u of h){const m=u.duration||1800,y=f+m;if(g>=f&&g<y){d={...u,position:g-f,remainingDuration:y-g};break}f=y}return!d&&h.length>0&&(d={...h[0],position:0,remainingDuration:h[0].duration||1800}),d?(d.clipsInSlot=h,console.log(`📅 Found scheduled content: ${d.show||d.filename}`),console.log(`📅 Position: ${d.position.toFixed(1)}s, Remaining: ${d.remainingDuration.toFixed(1)}s`),d):null}catch(e){return console.error("❌ Error getting scheduled video:",e),null}}calculateAdBreaks(e,t){if(!this.options.enableClipAds||!e||!e.clipsInSlot)return[];const i=e.slotDuration||3600,o=e.clipsInSlot.reduce((r,c)=>r+(c.duration||0),0),s=i-o;if(s<this.options.minAdDuration)return[];const n=Math.min(Math.floor(s/this.options.minAdDuration),this.options.maxAdsPerHour),l=[],a=this.calculateAdPositions(e.clipsInSlot,n,s);for(let r=0;r<a.length;r++){const c=this.selectAdVideo(e.day,e.time,r);c&&l.push({position:a[r],video:c,duration:c.duration||this.options.minAdDuration,slotContext:`${e.day}_${e.time}`,adIndex:r})}return l}calculateAdPositions(e,t,i){const o=[];if(e.length===0){const l=3600/(t+1);for(let a=0;a<t;a++)o.push(l*(a+1));return o}let s=0;const n=i/(t+1);for(let l=0;l<e.length&&o.length<t;l++)if(s+=e[l].duration||1800,l<e.length-1){const a=s+n;a<3600&&o.push(a)}return o.slice(0,t)}selectAdVideo(e,t,i){if(!this.savedVideos||Object.keys(this.savedVideos).length===0)return null;const o=Object.values(this.savedVideos),s=`${e}_${t}_${i}`,l=this.simpleHash(s)%o.length;return{...o[l],isAd:!0,adContext:{day:e,time:t,index:i}}}simpleHash(e){let t=0;for(let i=0;i<e.length;i++){const o=e.charCodeAt(i);t=(t<<5)-t+o,t=t&t}return Math.abs(t)}async getNextVideo(){if(this.options.enableScheduledOverride){const e=await this.getCurrentScheduledVideo();if(e&&e.filename)return console.log("📅 Playing scheduled content with priority"),{...e,source:"scheduled",adBreaks:this.calculateAdBreaks(e,e.remainingDuration)}}if(this.options.fallbackToSavedVideos&&this.savedVideos&&Object.keys(this.savedVideos).length>0){const e=Object.values(this.savedVideos),t=Math.floor(Math.random()*e.length),i=e[t];return console.log("📼 Playing saved video as fallback"),{...i,source:"saved_videos",adBreaks:this.options.enableClipAds?this.generateRandomAdBreaks():[]}}return console.log("📺 No content available, falling back to static/noise effect"),{filename:"static.mp4",title:"Static",description:"Static/noise effect",source:"static"}}generateRandomAdBreaks(){if(!this.options.enableClipAds||!this.savedVideos)return[];const e=Math.floor(Math.random()*3)+1,t=[];for(let i=0;i<e;i++){const o=300+i*600,s=this.selectAdVideo("fallback","any",i);s&&t.push({position:o,video:s,duration:s.duration||this.options.minAdDuration,slotContext:"fallback",adIndex:i})}return t}getWeekNumber(e){const t=new Date(e.getFullYear(),0,1),i=(e-t)/864e5;return Math.ceil((i+t.getDay()+1)/7)}on(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,[]),this.eventListeners.get(e).push(t)}off(e,t){if(this.eventListeners.has(e)){const i=this.eventListeners.get(e),o=i.indexOf(t);o>-1&&i.splice(o,1)}}emit(e,t){this.eventListeners.has(e)&&this.eventListeners.get(e).forEach(i=>{try{i(t)}catch(o){console.error(`Error in event listener for ${e}:`,o)}})}getStatus(){return{hasWeeklySchedule:!!this.weeklySchedule,hasSavedVideos:!!(this.savedVideos&&Object.keys(this.savedVideos).length>0),isScheduledVideoPlaying:this.isScheduledVideoPlaying,isBufferingScheduledVideo:this.isBufferingScheduledVideo,options:this.options}}}class p{constructor(){this.videos=[],this.currentVideoIndex=0,this.volume=50,this.isPlaying=!1,this.isBuffering=!1,this.scheduler=null,this.currentScheduledVideo=null,this.adBreaks=[],this.isAdPlaying=!1,this.loopSchedule=[],this.loopDuration=24*60*60*1e3,this.epochStart=Date.now(),this.currentProgramIndex=0,this.videoElement=null,this.nowPlaying=null,this.loadingText=null,this.initializeScheduler()}async initializeScheduler(){this.scheduler=new S({enableScheduledOverride:!0,enableClipAds:!0,maxAdsPerHour:4,minAdDuration:30,maxAdDuration:120,fallbackToSavedVideos:!0,fallbackToStatic:!0}),await this.scheduler.initialize()?(console.log("✅ Scheduler initialized successfully"),this.scheduler.on("scheduledVideoStart",t=>{console.log("📅 Scheduled video started:",t.show||t.filename),this.updateNowPlaying(t,"scheduled")}),this.scheduler.on("adBreakStart",t=>{console.log("📺 Ad break started"),this.updateNowPlaying(t.video,"ad")}),this.scheduler.on("fallbackVideo",t=>{console.log("📼 Playing fallback video"),this.updateNowPlaying(t,t.source)})):console.error("❌ Failed to initialize scheduler")}async initialize(){if(console.log("🚀 Initializing Enhanced Video Player..."),this.videoElement=document.getElementById("tvVideo"),this.nowPlaying=document.getElementById("nowPlaying"),this.loadingText=document.getElementById("loadingText"),!this.videoElement){console.error("❌ Video element not found");return}this.setupVideoPlayer(),await this.loadVideos(),this.createLoopSchedule(),await this.startHybridBroadcast(),console.log("✅ Enhanced Video Player initialized")}setupVideoPlayer(){this.videoElement.addEventListener("loadedmetadata",()=>{console.log("📺 Video metadata loaded"),this.isBuffering=!1,this.loadingText&&(this.loadingText.style.display="none")}),this.videoElement.addEventListener("canplay",()=>{console.log("📺 Video can play")}),this.videoElement.addEventListener("error",e=>{console.error("❌ Video error:",e),this.handleVideoError(e)}),this.videoElement.addEventListener("ended",()=>{console.log("📺 Video ended"),this.playNextVideo()}),this.videoElement.addEventListener("timeupdate",()=>{this.checkForAdBreaks()})}async loadVideos(){try{const e=await fetch("/saved_videos.json");if(!e.ok)throw new Error("Failed to fetch videos");const t=await e.json();this.videos=Object.keys(t).map(i=>({filename:i,...t[i]})),console.log(`📼 Loaded ${this.videos.length} videos`),this.scheduler&&(this.scheduler.savedVideos=t)}catch(e){console.error("❌ Error loading videos:",e),this.videos=[]}}createLoopSchedule(){if(this.videos.length===0)return;this.loopSchedule=[];let e=0;for(;e<this.loopDuration;)for(const t of this.videos){if(e>=this.loopDuration)break;const i=(t.duration||30)*1e3;this.loopSchedule.push({filename:t.filename,duration:i,offsetMs:e,videoIndex:this.videos.findIndex(o=>o.filename===t.filename)}),e+=i+2e3}console.log(`📺 Created loop schedule with ${this.loopSchedule.length} slots`)}async startHybridBroadcast(){console.log("📡 Starting hybrid broadcast...");try{const e=await this.scheduler?.getNextVideo();e&&e.source==="scheduled"?(console.log("📅 Playing scheduled content"),await this.playScheduledVideo(e)):(console.log("📺 No scheduled content, playing regular programming"),await this.playNextVideo())}catch(e){console.error("❌ Error starting broadcast:",e),await this.playNextVideo()}}async playScheduledVideo(e){this.currentScheduledVideo=e,this.adBreaks=e.adBreaks||[];const t=e.u||`/saved_videos/${e.filename}`;console.log(`📅 Playing scheduled video with priority URL: ${t}`),console.log(`📅 Video source: ${e.u?"External archive.org":"Local fallback"}`);try{const i=document.createElement("video");if(i.src=t,i.volume=0,i.muted=!0,await new Promise((o,s)=>{const n=setTimeout(()=>{s(new Error("Video loading timeout"))},1e4);i.addEventListener("loadedmetadata",()=>{clearTimeout(n),o()},{once:!0}),i.addEventListener("error",l=>{clearTimeout(n),s(l)},{once:!0}),i.load()}),i.duration&&!isNaN(i.duration))this.videoElement.src=t,this.videoElement.currentTime=e.position||0,this.videoElement.volume=this.volume/100,this.videoElement.muted=this.volume===0,await this.videoElement.play(),this.isPlaying=!0,this.updateNowPlaying(e,"scheduled"),console.log(`📅 Playing scheduled video: ${e.show||e.filename}`),console.log(`📅 Source: ${t}`);else throw new Error("Video has no duration or invalid")}catch(i){console.error("❌ Error playing scheduled video:",i),console.log(`📅 Failed to load: ${t}`),console.log("📅 Falling back to saved videos..."),await this.playNextVideo()}}async playNextVideo(){this.currentScheduledVideo=null,this.adBreaks=[],this.isAdPlaying=!1;const e=await this.scheduler?.getNextVideo();if(e&&e.source!=="saved_videos")e.source==="scheduled"?await this.playScheduledVideo(e):await this.playVideo(e);else{const o=(Date.now()-this.epochStart)%this.loopDuration,s=this.loopSchedule.find(n=>o>=n.offsetMs&&o<n.offsetMs+n.duration);if(s){this.currentProgramIndex=this.loopSchedule.indexOf(s);const n=this.videos[s.videoIndex];await this.playVideo(n)}else{this.currentProgramIndex=(this.currentProgramIndex+1)%this.loopSchedule.length;const n=this.loopSchedule[this.currentProgramIndex],l=this.videos[n.videoIndex];await this.playVideo(l)}}}async playVideo(e){if(!e||!e.filename){console.error("❌ Invalid video data");return}try{let t;e.source==="static"?t="/static.mp4":t=`/saved_videos/${e.filename}`,this.videoElement.src=t,this.videoElement.volume=this.volume/100,this.videoElement.muted=this.volume===0,await this.videoElement.play(),this.isPlaying=!0,this.updateNowPlaying(e,e.source||"regular"),console.log(`📺 Playing video: ${e.title||e.filename} from ${t}`)}catch(t){console.error("❌ Error playing video:",t),this.handleVideoError(t)}}checkForAdBreaks(){if(!this.adBreaks||this.adBreaks.length===0||this.isAdPlaying)return;const e=this.videoElement.currentTime,t=this.adBreaks.find(i=>Math.abs(i.position-e)<1&&!i.played);t&&this.playAdBreak(t)}async playAdBreak(e){console.log("📺 Playing ad break"),e.played=!0,this.isAdPlaying=!0;const t=this.videoElement.currentTime,i=this.videoElement.volume;try{await this.playVideo(e.video),this.updateNowPlaying(e.video,"ad"),setTimeout(async()=>{this.isAdPlaying=!1,this.currentScheduledVideo?(this.videoElement.currentTime=t,this.videoElement.volume=i,await this.videoElement.play(),this.updateNowPlaying(this.currentScheduledVideo,"scheduled")):await this.playNextVideo()},(e.video.duration||30)*1e3)}catch(o){console.error("❌ Error playing ad:",o),this.isAdPlaying=!1,this.videoElement.currentTime=t,this.videoElement.volume=i,await this.videoElement.play()}}updateNowPlaying(e,t){if(!this.nowPlaying)return;let i="📺",o="";switch(t){case"scheduled":i="📅",o="SCHEDULED";break;case"scheduled-local":i="📅",o="SCHEDULED (LOCAL)";break;case"ad":i="📢",o="ADVERTISEMENT";break;case"saved_videos":i="📼",o="SAVED CLIP";break;case"static":i="📺",o="STATIC/NOISE";break;default:i="📺",o="REGULAR"}const s=e.show||e.title||e.filename||"Unknown";this.nowPlaying.innerHTML=`${i} NOW PLAYING: ${s} [${o}]`}handleVideoError(e){console.error("❌ Video playback error:",e),setTimeout(()=>{this.playNextVideo()},2e3)}getSchedulerStatus(){return this.scheduler?.getStatus()||{hasWeeklySchedule:!1,hasSavedVideos:this.videos.length>0,hasStaticSchedule:!1,isScheduledVideoPlaying:!!this.currentScheduledVideo,isBufferingScheduledVideo:this.isBuffering}}async checkForScheduledContent(){if(!this.scheduler)return;const e=await this.scheduler.getCurrentScheduledVideo();e&&!this.currentScheduledVideo&&(console.log("📅 New scheduled content detected, switching..."),await this.playScheduledVideo(e))}}window.EnhancedVideoPlayer=p;document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{window.videoPlayer=new p,window.videoPlayer.initialize()}):(window.videoPlayer=new p,window.videoPlayer.initialize());
